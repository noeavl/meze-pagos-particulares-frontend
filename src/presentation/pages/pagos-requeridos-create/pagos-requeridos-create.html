<div class="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Crear Pago Requerido</h1>
        <p class="text-gray-600 text-sm mt-1">
          Registra un nuevo pago de concepto requerido
        </p>
      </div>
    </div>
  </div>

  <!-- Form Card -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <form [formGroup]="pagoForm" (ngSubmit)="onSubmit()">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- CURP del Estudiante -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            CURP del Estudiante *
          </label>
          <p-inputgroup>
            <input
              type="text"
              pInputText
              formControlName="curp"
              placeholder="Ingrese la CURP del estudiante (18 caracteres)"
              (input)="onCurpChange($event)"
              (keydown.enter)="buscarEstudiantePorCurp()"
              maxlength="18"
              [class.ng-invalid]="isFieldInvalid('curp')"
            />
            <p-inputgroup-addon>
              <button
                type="button"
                pButton
                label="Buscar"
                icon="fa-solid fa-search"
                class="p-button-primary"
                (click)="buscarEstudiantePorCurp()"
                [disabled]="
                  buscandoEstudiante ||
                  pagoForm.get('curp')?.value?.length !== 18
                "
                [loading]="buscandoEstudiante"
                pTooltip="Buscar estudiante por CURP"
              ></button>
            </p-inputgroup-addon>
          </p-inputgroup>
          @if (isFieldInvalid('curp')) {
          <small class="text-red-600 mt-1 block">
            {{
              getFieldError("curp") ||
                "La CURP es requerida y debe tener 18 caracteres"
            }}
          </small>
          } @if (errorBusquedaEstudiante) {
          <small class="text-red-600 mt-1 block">{{
            errorBusquedaEstudiante
          }}</small>
          }
        </div>

        <!-- Información del Estudiante Encontrado -->
        @if (estudianteEncontrado) {
        <div class="md:col-span-2">
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center mb-2">
              <i class="fa-solid fa-user-check text-green-600 mr-2"></i>
              <h4 class="text-sm font-semibold text-green-800">
                Estudiante Encontrado
              </h4>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-600">Nombre:</span>
                <span class="ml-2 font-medium"
                  >{{ estudianteEncontrado.nombres }}
                  {{ estudianteEncontrado.apellidoPaterno }}
                  {{ estudianteEncontrado.apellidoMaterno }}</span
                >
              </div>
              <div>
                <span class="text-gray-600">Nivel:</span>
                <span class="ml-2 font-medium"
                  >{{ estudianteEncontrado.nivel.displayValue }} -
                  {{ estudianteEncontrado.grado }}°</span
                >
              </div>
              <div>
                <span class="text-gray-600">Grupo:</span>
                <span class="ml-2 font-medium">{{
                  estudianteEncontrado.grupo || "N/A"
                }}</span>
              </div>
              <div>
                <span class="text-gray-600">Modalidad:</span>
                <span class="ml-2 font-medium">{{
                  estudianteEncontrado.modalidad.displayValue
                }}</span>
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Concepto -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Concepto Requerido *
          </label>
          <p-select
            formControlName="concepto_id"
            [options]="conceptosOptions"
            placeholder="Seleccionar concepto"
            optionLabel="label"
            optionValue="value"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
            (onChange)="onConceptoChange($event.value)"
            class="w-full"
            [class.ng-invalid]="isFieldInvalid('concepto_id')"
          />
          @if (isFieldInvalid('concepto_id')) {
          <small class="text-red-600 mt-1 block">
            {{ getFieldError("concepto_id") || "El concepto es requerido" }}
          </small>
          }
        </div>

        <!-- Folio -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Folio *
          </label>
          <input
            type="text"
            pInputText
            formControlName="folio"
            placeholder="Ingrese el folio del pago"
            class="w-full"
            [class.ng-invalid]="isFieldInvalid('folio')"
          />
          @if (isFieldInvalid('folio')) {
          <small class="text-red-600 mt-1 block">
            {{ getFieldError("folio") || "El folio es requerido" }}
          </small>
          }
        </div>

        <!-- Monto -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Monto *
          </label>
          <p-inputnumber
            formControlName="monto"
            mode="currency"
            currency="MXN"
            locale="es-MX"
            [min]="0"
            [maxFractionDigits]="2"
            placeholder="0.00"
            class="w-full"
            [class.ng-invalid]="isFieldInvalid('monto')"
          />
          @if (isFieldInvalid('monto')) {
          <small class="text-red-600 mt-1 block">
            {{
              getFieldError("monto") ||
                "El monto es requerido y debe ser mayor a 0"
            }}
          </small>
          }
        </div>

        <!-- Método de Pago -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Método de Pago *
          </label>
          <p-select
            formControlName="metodo_pago"
            [options]="metodosOptions"
            placeholder="Seleccionar método"
            optionLabel="label"
            optionValue="value"
            class="w-full"
            [class.ng-invalid]="isFieldInvalid('metodo_pago')"
          />
          @if (isFieldInvalid('metodo_pago')) {
          <small class="text-red-600 mt-1 block">
            {{
              getFieldError("metodo_pago") || "El método de pago es requerido"
            }}
          </small>
          }
        </div>

        <!-- Fecha -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Fecha de Pago *
          </label>
          <p-datepicker
            formControlName="fecha"
            placeholder="Seleccionar fecha"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            class="w-full"
            [class.ng-invalid]="isFieldInvalid('fecha')"
          />
          @if (isFieldInvalid('fecha')) {
          <small class="text-red-600 mt-1 block">
            {{ getFieldError("fecha") || "La fecha es requerida" }}
          </small>
          }
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-200">
        <button
          type="button"
          pButton
          label="Cancelar"
          class="p-button-text"
          (click)="onCancel()"
          [disabled]="loading"
        ></button>
        <button
          type="submit"
          pButton
          label="Crear Pago"
          icon="fa-solid fa-save"
          [loading]="loading"
          [disabled]="
            pagoForm.invalid || !estudianteEncontrado || buscandoEstudiante
          "
        ></button>
      </div>
    </form>
  </div>

  <p-toast position="bottom-right" />
</div>
