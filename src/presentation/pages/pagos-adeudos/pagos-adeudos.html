<div class="p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Pagos de Adeudos</h2>
    <button
      [routerLink]="['/pagos-adeudos-create']"
      pButton
      type="button"
      label="Nuevo Pago"
      icon="pi pi-plus"
      class="p-button-primary"
    ></button>
  </div>

  <!-- Filtros para pagos -->
  <div class="mb-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Buscador -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input
            type="text"
            pInputText
            placeholder="Buscar por estudiante, folio..."
            (input)="onSearchPagos($event)"
            class="w-full"
          />
        </span>
      </div>
      
      <!-- Filtro por método -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Método de pago</label>
        <select 
          [(ngModel)]="selectedMetodoPago"
          class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">Todos los métodos</option>
          <option *ngFor="let metodo of metodoOptions" [value]="metodo.value">
            {{ metodo.label }}
          </option>
        </select>
      </div>
      
      <!-- Filtro por nivel -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Nivel</label>
        <select 
          [(ngModel)]="selectedNivelPago"
          (ngModelChange)="onNivelChangePagos()"
          class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="">Todos los niveles</option>
          <option *ngFor="let nivel of nivelOptions" [value]="nivel.value">
            {{ nivel.label }}
          </option>
        </select>
      </div>
      
      <!-- Filtro por grado -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Grado</label>
        <select 
          [(ngModel)]="selectedGradoPago"
          [disabled]="!selectedNivelPago"
          class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
        >
          <option value="">{{ selectedNivelPago ? 'Todos los grados' : 'Selecciona un nivel primero' }}</option>
          <option *ngFor="let grado of availableGradoOptionsPagos" [value]="grado">
            {{ grado }}°
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Tabla de pagos -->
  <p-table
    [value]="filteredPagos"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} - {last} de {totalRecords} pagos de adeudos"
    [tableStyle]="{ 'min-width': '50rem' }"
    styleClass="p-datatable-gridlines"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
        <th pSortableColumn="folio">
          Folio <p-sortIcon field="folio"></p-sortIcon>
        </th>
        <th pSortableColumn="estudiante">
          Estudiante <p-sortIcon field="estudiante"></p-sortIcon>
        </th>
        <th pSortableColumn="metodo">
          Método <p-sortIcon field="metodo"></p-sortIcon>
        </th>
        <th pSortableColumn="monto">
          Monto <p-sortIcon field="monto"></p-sortIcon>
        </th>
        <th pSortableColumn="fecha">
          Fecha <p-sortIcon field="fecha"></p-sortIcon>
        </th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-pago>
      <tr>
        <td>{{ pago.id }}</td>
        <td class="font-medium">{{ pago.folio }}</td>
        <td>
          <span class="font-medium">
            {{ pago.estudiante.nombres }}
            {{ pago.estudiante.apellidoPaterno }}
          </span>
          <br />
          <small class="text-gray-500">
            {{ pago.estudiante.nivel.displayValue }} -
            {{ pago.estudiante.grado }}°
          </small>
        </td>
        <td>
          <p-tag 
            [value]="pago.metodo | titlecase"
            [severity]="getMetodoSeverity(pago.metodo)"
            [rounded]="true"
          ></p-tag>
        </td>
        <td class="font-semibold text-green-600">
          ${{ pago.monto | number : "1.2-2" }}
        </td>
        <td>{{ pago.fecha | date:'dd/MM/yyyy':'UTC' }}</td>
        <td>
          <div class="flex gap-2">
            <button
              [routerLink]="['/pago/edit', pago.id]"
              pButton
              type="button"
              icon="fa-solid fa-pencil"
              class="p-button-rounded p-button-text p-button-warn"
              pTooltip="Editar"
            ></button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center py-8">
          <div class="flex flex-col items-center">
            <i class="pi pi-credit-card text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">No se encontraron pagos de adeudos</p>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="footer">
      <tr class="bg-gray-50 font-bold">
        <td colspan="4" class="text-right">Total de Pagos:</td>
        <td class="text-green-600">
          ${{ totalPagos | number : "1.2-2" }}
        </td>
        <td colspan="2"></td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Mensaje de error -->
  @if (error) {
  <div class="mb-4 p-4 bg-red-100 text-red-700 rounded-lg">
    {{ error }}
  </div>
  }

</div>