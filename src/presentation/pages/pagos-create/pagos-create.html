<div class="max-w-5xl mx-auto p-6 bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Registrar Pago</h1>
        <p class="text-gray-600 text-sm mt-1">Procesar nuevo pago de adeudo</p>
      </div>
      <button
        [routerLink]="['/adeudos']"
        pButton
        type="button"
        label="Volver"
        icon="pi pi-arrow-left"
        class="p-button-outlined p-button-secondary"
      ></button>
    </div>
  </div>

  @if (error()) {
  <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
    {{ error() }}
  </div>
  } @if (loading()) {
  <div class="flex justify-center items-center py-12">
    <p-progressSpinner strokeWidth="3" animationDuration="1s"></p-progressSpinner>
  </div>
  } @if(!loading() && adeudo()){
  <form [formGroup]="pagoForm" (ngSubmit)="onSubmit()">
    
    <!-- Student & Debt Information -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <div class="grid lg:grid-cols-2 gap-8">
        
        <!-- Student Info -->
        <div>
          <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
            Información del Estudiante
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Nombre:</span>
              <span class="font-medium text-gray-900">
                {{ adeudo()?.estudiante?.nombres }} {{ adeudo()?.estudiante?.apellidoPaterno }} {{ adeudo()?.estudiante?.apellidoMaterno }}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Modalidad:</span>
              <span class="text-gray-900">{{ adeudo()?.estudiante?.modalidad?.displayValue }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Nivel:</span>
              <span class="text-gray-900">{{ adeudo()?.estudiante?.nivel?.displayValue }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Grado:</span>
              <span class="text-gray-900">{{ adeudo()?.estudiante?.grado }}°</span>
            </div>
          </div>
        </div>

        <!-- Debt Info -->
        <div>
          <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
            Información del Adeudo
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Concepto:</span>
              <span class="font-medium text-gray-900">{{ adeudo()?.concepto?.nombre }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Periodo:</span>
              <span class="text-gray-900">{{ adeudo()?.concepto?.periodo?.displayValue }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Estado:</span>
              <span class="text-gray-900">{{ adeudo()?.estado?.displayValue }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Vencimiento:</span>
              <span class="text-gray-900">{{ adeudo()?.fechaVencimiento | date : "dd/MM/yyyy" }}</span>
            </div>
          </div>
          
          <!-- Amount Summary -->
          <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-600 text-sm">Total:</span>
              <span class="font-semibold text-gray-900">{{ adeudo()?.montoTotal | currency }}</span>
            </div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-600 text-sm">Pagado:</span>
              <span class="text-green-600 font-medium">{{ adeudo()?.montoPagado | currency }}</span>
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
              <span class="font-medium text-gray-900">Pendiente:</span>
              <span class="font-bold text-red-600 text-lg">{{ adeudo()?.montoPendiente | currency }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment History -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
        Historial de Pagos
      </h3>
      <p-table
        [value]="paymentHistory()"
        [paginator]="true"
        [rows]="5"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} - {last} de {totalRecords} pagos"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="text-left">Folio</th>
            <th class="text-right">Monto</th>
            <th class="text-left">Método</th>
            <th class="text-left">Fecha</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-pago>
          <tr>
            <td class="font-medium">{{ pago.folio }}</td>
            <td class="text-right font-semibold text-green-600">{{ pago.monto | currency : "MXN" }}</td>
            <td>{{ pago.metodo }}</td>
            <td>{{ pago.fecha | date : "dd/MM/yyyy" }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="4" class="text-center py-8 text-gray-500">
              Sin pagos registrados
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Payment Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-6 pb-2 border-b border-gray-200">
        Nuevo Pago
      </h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Folio</label>
            <input
              type="text"
              pInputText
              formControlName="folio"
              placeholder="Número de folio"
              class="w-full"
              [class.p-invalid]="hasFieldError('folio') || (pagoForm.get('folio')?.invalid && pagoForm.get('folio')?.touched)"
            />
            @if (hasFieldError('folio')) {
              <small class="text-red-600 mt-1 block">{{ getFieldError('folio') }}</small>
            } @else if (pagoForm.get('folio')?.invalid && pagoForm.get('folio')?.touched) {
              <small class="text-red-600 mt-1 block">Este campo es requerido</small>
            }
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pago</label>
            <p-select
              formControlName="metodo_pago"
              [options]="paymentOptions"
              optionLabel="name"
              optionValue="value"
              placeholder="Seleccionar método"
              class="w-full"
            ></p-select>
          </div>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
            <p-datepicker
              formControlName="fecha"
              placeholder="Seleccionar fecha"
              class="w-full"
            ></p-datepicker>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Monto</label>
            <p-inputnumber
              formControlName="monto"
              placeholder="0.00"
              [showClear]="false"
              mode="decimal"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              class="w-full"
              currency="MXN"
              locale="es-MX"
            ></p-inputnumber>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end">
      <button
        pButton
        type="submit"
        label="Registrar Pago"
        icon="pi pi-check"
        class="px-8 py-3"
        [loading]="loading()"
        [disabled]="pagoForm.invalid || loading()"
      ></button>
    </div>
  </form>
  }

  <!-- Toast para notificaciones -->
  <p-toast position="bottom-right" />
</div>
